#!/usr/bin/env bash
# ABOUTME: Bash wrapper for ralph-orchestrator with convenience features
# ABOUTME: Provides simplified interface and common workflow shortcuts

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ORCHESTRATOR="$SCRIPT_DIR/ralph_orchestrator.py"

# Default values
DEFAULT_AGENT="auto"
DEFAULT_PROMPT="PROMPT.md"

# Help function
show_help() {
    cat << EOF
Ralph Orchestrator - Put AI in a loop until done

Usage: ralph [COMMAND] [OPTIONS]

Commands:
    run         Run the orchestrator (default)
    init        Initialize a new Ralph project
    status      Show current Ralph status
    clean       Clean up agent workspace
    help        Show this help message

Options:
    -a, --agent AGENT       AI agent to use (claude/q/gemini/auto)
    -p, --prompt FILE       Prompt file (default: PROMPT.md)
    -i, --iterations N      Max iterations (default: 100)
    -t, --time SECONDS      Max runtime in seconds
    -v, --verbose          Verbose output
    -d, --dry-run          Dry run mode

Examples:
    ralph                   # Run with defaults
    ralph run -a claude     # Use Claude
    ralph init              # Set up new project
    ralph status            # Check progress
    ralph clean             # Clean workspace

EOF
}

# Initialize project
init_project() {
    echo -e "${GREEN}Initializing Ralph project...${NC}"
    
    # Create directories
    mkdir -p .agent/{prompts,checkpoints,metrics,plans,memory}
    
    # Create default PROMPT.md if it doesn't exist
    if [ ! -f "PROMPT.md" ]; then
        cat > PROMPT.md << 'EOF'
# Task: [Describe your task here]

## Requirements
- [ ] Requirement 1
- [ ] Requirement 2

## Success Criteria
- All requirements met
- Tests pass
- Code is clean

<!-- Add TASK_COMPLETE when done -->
EOF
        echo -e "${GREEN}Created PROMPT.md template${NC}"
    fi
    
    # Initialize git if not already
    if [ ! -d ".git" ]; then
        git init
        echo -e "${GREEN}Initialized git repository${NC}"
    fi
    
    echo -e "${GREEN}Ralph project initialized!${NC}"
}

# Show status
show_status() {
    echo -e "${YELLOW}Ralph Orchestrator Status${NC}"
    echo "========================="
    
    # Check for PROMPT.md
    if [ -f "PROMPT.md" ]; then
        echo -e "Prompt: ${GREEN}PROMPT.md exists${NC}"
        if grep -q "TASK_COMPLETE" PROMPT.md; then
            echo -e "Status: ${GREEN}TASK COMPLETE${NC}"
        else
            echo -e "Status: ${YELLOW}IN PROGRESS${NC}"
        fi
    else
        echo -e "Prompt: ${RED}PROMPT.md not found${NC}"
    fi
    
    # Check iterations
    if [ -d ".agent/metrics" ]; then
        LATEST_STATE=$(ls -t .agent/metrics/state_*.json 2>/dev/null | head -1)
        if [ -n "$LATEST_STATE" ]; then
            echo -e "\nLatest metrics: $LATEST_STATE"
            if command -v jq &> /dev/null; then
                jq '{iteration_count, runtime, errors: (.errors | length)}' "$LATEST_STATE" 2>/dev/null || true
            fi
        fi
    fi
    
    # Check git status
    if [ -d ".git" ]; then
        echo -e "\nGit checkpoints:"
        git log --oneline -5 2>/dev/null | head -5 || echo "No checkpoints yet"
    fi
}

# Clean workspace
clean_workspace() {
    echo -e "${YELLOW}Cleaning Ralph workspace...${NC}"
    
    read -p "Remove .agent directory? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf .agent
        echo -e "${GREEN}Removed .agent directory${NC}"
    fi
    
    read -p "Reset git to last checkpoint? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git reset --hard HEAD
        echo -e "${GREEN}Reset to last checkpoint${NC}"
    fi
}

# Main run function
run_orchestrator() {
    if [ ! -f "$ORCHESTRATOR" ]; then
        echo -e "${RED}Error: ralph-orchestrator.py not found at $ORCHESTRATOR${NC}"
        exit 1
    fi
    
    # Build command
    CMD="python3 $ORCHESTRATOR"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -a|--agent)
                CMD="$CMD --agent $2"
                shift 2
                ;;
            -p|--prompt)
                CMD="$CMD --prompt $2"
                shift 2
                ;;
            -i|--iterations)
                CMD="$CMD --max-iterations $2"
                shift 2
                ;;
            -t|--time)
                CMD="$CMD --max-runtime $2"
                shift 2
                ;;
            -v|--verbose)
                CMD="$CMD --verbose"
                shift
                ;;
            -d|--dry-run)
                CMD="$CMD --dry-run"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${GREEN}Starting Ralph Orchestrator...${NC}"
    echo "Command: $CMD"
    echo "========================="
    
    # Run the orchestrator
    exec $CMD
}

# Main logic
case "${1:-run}" in
    run)
        shift
        run_orchestrator "$@"
        ;;
    init)
        init_project
        ;;
    status)
        show_status
        ;;
    clean)
        clean_workspace
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        # If no command given, assume it's run with the argument as an option
        run_orchestrator "$@"
        ;;
esac